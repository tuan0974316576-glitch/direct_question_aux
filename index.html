<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çœŸå•å¥æå•å­—ç‰¹è¨“</title>
<link rel="manifest" href="manifest.json">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&family=Nunito:wght@400;700;900&display=swap');

* { 
        -webkit-tap-highlight-color: transparent; 
        box-sizing: border-box; 
    }
        /* --- ğŸ¨ æ ¸å¿ƒé…è‰² (æ—¥ç³»æ–‡å…·é¢¨) --- */
        :root {
            --base-bg: #fdfbf7;       
            --primary-color: #4ecdc4;  
            --primary-dark: #2cb5ac;   
            --secondary-color: #ffe66d; 
            --secondary-dark: #ffb703;
            --danger-color: #ff6b6b;   
            --warning-color: #ffbe0b;
            --correct-color: #6bf178;  
            --text-color: #444444;     
            --border-color: #d1d8e0;   
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

        html, body {
            min-height: 100%;
            margin: 0;
            padding: 0;
            overflow-y: auto; /* å…è¨±æ²å‹• */
        }

        body {
            font-family: "Nunito", "M PLUS Rounded 1c", sans-serif;
            background-color: var(--base-bg);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            padding: 20px 10px;
        }

        #game-container {
            width: 100%;
            max-width: 800px; 
            background-color: #ffffff;
            border: 3px dashed var(--primary-color);
            border-radius: 30px;
            box-shadow: 0 0 0 6px #ffffff, 0 10px 20px rgba(78, 205, 196, 0.15);
            padding: 24px;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: 85vh;
        }

        h1 {
            text-align: center;
            color: var(--primary-dark);
            margin: 0 0 20px 0;
            font-size: 24px;
            font-weight: 900;
        }

        /* --- é€šç”¨æŒ‰éˆ• --- */
        .btn-style {
            border-radius: 50px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }
        .btn-style:active { transform: translateY(2px); box-shadow: none !important; }

        /* --- 1. é–‹å§‹ç•«é¢ --- */
        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            padding: 20px 0;
        }

        .setting-box {
            background: #fff;
            border: 2px dashed #d1d8e0;
            border-radius: 20px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            margin-bottom: 30px;
            text-align: center;
        }

        /* Slider æ¨£å¼ */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            margin: 15px 0;
            background: transparent;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            border: 1px solid #ced4da;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            margin-top: -8px;
            cursor: pointer;
        }

        .big-start-btn {
            background-color: var(--secondary-color);
            color: #5d4037;
            font-size: 22px;
            padding: 15px 80px;
            box-shadow: 0 6px 0 var(--secondary-dark), 0 10px 10px rgba(255, 193, 7, 0.3);
        }
        .big-start-btn:hover { transform: translateY(-2px); background-color: #ffeb85; }

        /* --- 2. éŠæˆ²å€åŸŸ --- */
        #game-area { display: none; flex-direction: column; width: 100%; }

        /* é€²åº¦æ¢èˆ‡è¨ˆæ™‚å™¨ */
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: 800;
            color: var(--primary-dark);
            font-size: 16px;
        }

        /* è¨ˆæ™‚å™¨æ¨£å¼ */
        .timer-wrapper {
            flex: 1;
            margin: 0 15px;
            position: relative;
            height: 24px;
            background: #f1f3f5;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #timer-bar {
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 100%;
            background-color: var(--primary-color);
            transition: width 0.1s linear, background-color 0.3s;
            z-index: 1;
        }
        #timer-text {
            position: relative;
            z-index: 2;
            font-size: 14px;
            color: #555;
            font-weight: 900;
            text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }

        /* é¡Œç›®é¡¯ç¤ºå€ (ä¸­æ–‡) */
        #question-box {
            background-color: #ffffff;
            border: 4px dashed var(--primary-color);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 6px 0 rgba(78, 205, 196, 0.2);
        }

        #ch-sentence {
            font-size: 22px;
            font-weight: 900;
            color: var(--text-color);
            line-height: 1.4;
        }

        /* 23 æŒ‰éˆ•æ’ç‰ˆ */
        #keyboard-area {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .group-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 12px;
            border: 2px solid #eee;
            position: relative;
        }

        /* å·¦ä¸Šè§’çš„åˆ†é¡æ¨™ç±¤ */
        .group-label {
            position: absolute;
            top: -10px;
            left: 10px;
            background: var(--secondary-color);
            color: #5d4037;
            font-size: 12px;
            font-weight: 900;
            padding: 2px 10px;
            border-radius: 10px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }

        .btn-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* é è¨­ 3 æ¬„ */
            gap: 8px;
            margin-top: 5px;
        }

        /* é‡å°ä¸åŒæ•¸é‡çš„æŒ‰éˆ•å¾®èª¿ Grid */
        .grid-5 { grid-template-columns: repeat(5, 1fr); } /* Modals 5å€‹ */
        .grid-6 { grid-template-columns: repeat(3, 1fr); } /* Perfect 6å€‹ (3x2) */
        .grid-3 { grid-template-columns: repeat(3, 1fr); } /* Do 3å€‹ */
        .grid-9 { grid-template-columns: repeat(3, 1fr); } /* Be 9å€‹ (3x3) */

        /* RWD: æ‰‹æ©Ÿç‰ˆ Modal è®Š 3+2 */
        @media (max-width: 500px) {
            .grid-5 { grid-template-columns: repeat(3, 1fr); }
        }

        .grammar-btn {
            background-color: white;
            border: 2px dashed #ced4da;
            color: #666;
            font-size: 14px; /* å­—é«”ç¨å°ä»¥å®¹ç´é•·å­— */
            padding: 5px;
            box-shadow: 0 3px 0 #dee2e6;
            min-height: 48px;
            white-space: normal;
            line-height: 1.1;
        }

        .grammar-btn:hover:not(:disabled) { 
            background-color: #e3f2fd; 
            border-color: var(--primary-color); 
            color: var(--primary-dark); 
            transform: translateY(-2px); 
        }
        
        /* æ­£ç¢º/éŒ¯èª¤æ¨£å¼ */
        .grammar-btn.correct {
            background-color: var(--primary-color) !important;
            color: white !important;
            border-style: solid !important;
            border-color: var(--primary-dark) !important;
            box-shadow: 0 3px 0 var(--primary-dark) !important;
            opacity: 1 !important;
        }
        .grammar-btn.wrong {
            background-color: #ffe3e3 !important;
            color: var(--danger-color) !important;
            border-color: var(--danger-color) !important;
            opacity: 0.5;
        }

        /* --- Feedback --- */
        #feedback-area { margin-top: auto; min-height: 80px; margin-bottom: 20px; }
        
        .feedback-card {
            background-color: #fff;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .feedback-correct { border-color: var(--correct-color); background: #e8f5e9; }
        .feedback-wrong { border-color: var(--danger-color); background: #ffebee; }

        .en-sentence-reveal {
            font-size: 20px;
            font-weight: 700;
            color: #2d3436;
            margin: 8px 0;
        }
        .highlight { color: var(--primary-dark); text-decoration: underline; font-weight: 900; }

        #next-btn {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            font-size: 18px;
            padding: 12px;
            box-shadow: 0 5px 0 var(--primary-dark);
            display: none;
        }
        #next-btn:hover { background-color: var(--primary-dark); }

        /* --- 3. çµç®—ç•«é¢ --- */
        #end-screen { display: none; flex-direction: column; align-items: center; width: 100%; }
        
        .final-score {
            font-size: 32px;
            font-weight: 900;
            color: #5d4037;
            background-color: var(--secondary-color);
            border: 4px solid #fff;
            border-radius: 25px;
            padding: 15px 40px;
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.3);
            margin-bottom: 20px;
        }

        .error-list { width: 100%; text-align: left; margin-bottom: 20px; flex: 1; overflow-y: auto; max-height: 50vh;}
        .error-item {
            background: white;
            border: 2px dashed #ffc9c9;
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 8px;
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* RWD */
        @media (max-width: 600px) {
            #game-container { padding: 15px; border-radius: 0; border: none; min-height: 100vh; }
            .grammar-btn { font-size: 13px; min-height: 42px; padding: 2px; }
        }
/* --- æº«ç¿’ç­†è¨˜ Modal æ¨£å¼ --- */
.note-btn {
    background-color: #fff;
    border: 2px dashed var(--primary-color);
    color: var(--primary-dark);
    font-size: 16px;
    padding: 10px 20px;
    border-radius: 50px;
    font-weight: 800;
    cursor: pointer;
    box-shadow: 0 4px 0 rgba(78, 205, 196, 0.2);
    margin-top: 15px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}
.note-btn:hover {
    background-color: #e3f2fd;
    transform: translateY(-2px);
}

/* å½ˆå‡ºè¦–çª—èƒŒæ™¯ */
#note-modal {
    display: none; /* é è¨­éš±è— */
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5); /* åŠé€æ˜é»‘åº• */
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
}

/* ç­†è¨˜å…§å®¹å¡ç‰‡ */
.note-content {
    background-color: #fff;
    width: 100%;
    max-width: 600px;
    max-height: 85vh; /* é¿å…å¤ªé•·è¶…å‡ºè¢å¹• */
    overflow-y: auto; /* å…è¨±å…§éƒ¨æ²å‹• */
    border-radius: 20px;
    border: 4px dashed var(--primary-color);
    padding: 25px;
    position: relative;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    text-align: left;
    font-family: "Nunito", "M PLUS Rounded 1c", sans-serif;
}

/* ç­†è¨˜å…§æ–‡æ’ç‰ˆ */
.note-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px dashed #eee; }
.note-title { font-size: 18px; font-weight: 900; color: var(--primary-dark); margin-bottom: 10px; display:flex; align-items:center; }
.note-tag { background: var(--secondary-color); color: #5d4037; padding: 2px 8px; border-radius: 6px; font-size: 12px; margin-right: 8px; }
.note-text { font-size: 15px; line-height: 1.6; color: #555; }
.note-example { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 5px; font-size: 14px; border-left: 4px solid var(--primary-color); }
.wrong-ex { color: var(--danger-color); text-decoration: line-through; margin-right: 10px; }
.formula-box { background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center; font-weight: 900; color: var(--primary-dark); font-size: 18px; margin-bottom: 15px; border: 2px solid #b3e5fc; }

/* é—œé–‰æŒ‰éˆ• */
.close-note {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 24px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    background: none;
    border: none;
}
/* --- ğŸ¤ è·Ÿè®€åŠŸèƒ½æ¨£å¼ --- */
@keyframes pulse-white {
    0% { box-shadow: 0 0 0 0 rgba(78, 205, 196, 0.6); transform: scale(1); }
    50% { transform: scale(1.05); }
    70% { box-shadow: 0 0 0 15px rgba(78, 205, 196, 0); }
    100% { box-shadow: 0 0 0 0 rgba(78, 205, 196, 0); transform: scale(1); }
}

.mic-btn {
    background-color: #ffffff;
    border: 3px dashed var(--primary-color);
    border-radius: 50px;
    padding: 10px 30px;
    font-size: 16px;
    font-weight: bold;
    color: var(--primary-color);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s;
    box-shadow: 0 4px 0 rgba(0,0,0,0.05);
    outline: none;
    min-width: 200px;
    margin-top: 10px;
}

.mic-btn:disabled {
    opacity: 0.5;
    cursor: wait;
    background-color: #f1f3f5;
    border-color: #ccc;
    color: #999;
    box-shadow: none;
    transform: none !important;
}

.mic-btn:hover:not(:disabled) {
    background-color: #e3f2fd;
    transform: translateY(-2px);
    box-shadow: 0 6px 10px rgba(0,0,0,0.1);
}

.mic-btn.listening {
    background-color: var(--danger-color) !important;
    border: 3px solid white !important;
    color: white !important;
    animation: pulse-white 1.5s infinite;
    box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
}

.mic-result { margin-top: 10px; min-height: 25px; }

.diff-word {
    font-weight: bold;
    font-size: 18px;
    margin: 0 3px;
    padding: 2px 5px;
    border-radius: 4px;
    display: inline-block;
}
.diff-correct { color: #2d6a4f; background-color: #d8f3dc; }
.diff-wrong { color: #c92a2a; background-color: #ffe3e3; text-decoration: line-through; }
.diff-missed { color: #adb5bd; border: 1px dashed #dee2e6; }    
/* --- åˆ†é¡æŒ‰éˆ•æ¨£å¼ --- */
        .section-title {
            font-size: 16px; color: #888; margin: 15px 0 8px 0; font-weight: 800;
            width: 100%; text-align: left; border-bottom: 2px dashed #eee; padding-bottom: 5px;
        }
        .category-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; margin-bottom: 10px;
        }
        .option-btn {
            background-color: #ffffff; border: 2px dashed #d1d8e0; border-radius: 50px;
            padding: 12px 10px; cursor: pointer; text-align: center; font-weight: 800;
            color: #888; transition: all 0.2s; box-shadow: 0 4px 0 #f0f0f0; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
        }
        .option-btn:hover { background-color: #e0fbfc; border-color: var(--primary-color); color: var(--primary-dark); transform: translateY(-2px); }
        .option-btn.selected {
            background-color: var(--primary-color) !important; color: white !important;
            border: 2px solid var(--primary-color) !important; box-shadow: 0 4px 0 var(--primary-dark) !important;
            transform: translateY(-2px);
        }
        .option-btn input { display: none; }
</style>
</head>
<body>

<div id="game-container">
    <h1>â“ çœŸå•å¥æå•å­—ç‰¹è¨“ â“</h1>

    <div id="start-screen">
<div class="section-title">é¸æ“‡ç‰¹è¨“é¡åˆ¥ (é è¨­å…¨é¸)</div>
        <div class="category-grid">
            <label class="option-btn selected"><input type="checkbox" name="cat" value="Modals" checked>Modals</label>
            <label class="option-btn selected"><input type="checkbox" name="cat" value="Perfect" checked>Perfect</label>
            <label class="option-btn selected"><input type="checkbox" name="cat" value="DoDid" checked>Do/Did</label>
            <label class="option-btn selected"><input type="checkbox" name="cat" value="Be" checked>Be Verbs</label>
        </div>
        <div class="setting-box">
            <div style="font-size:18px; font-weight:bold; color:#555; margin-bottom:10px;">è¨­å®šé¡Œç›®æ•¸é‡</div>
            <div style="font-size:32px; font-weight:900; color:var(--primary-dark);" id="q-count-display">10</div>
            <input type="range" id="q-slider" min="5" max="50" step="5" value="10" oninput="updateSlider(this.value)">
        </div>
 <button class="btn-style big-start-btn" id="start-btn" onclick="startGame(false)">é–‹å§‹æŒ‘æˆ°</button>
<button class="note-btn" onclick="openNote()">
    ğŸ“– æº«ç¿’ç­†è¨˜ (Cheat Sheet)
</button>
    </div>

    <div id="game-area">
        <div id="top-bar">
            <span id="q-num-display">1/10</span>
            <div class="timer-wrapper">
                <div id="timer-bar"></div>
                <div id="timer-text">15.0</div>
            </div>
            <span id="score-display">Score: 0</span>
        </div>

        <div id="question-box">
            <div id="ch-sentence">é¡Œç›®è¼‰å…¥ä¸­...</div>
        </div>

        <div id="keyboard-area">
            
            <div class="group-section">
                <span class="group-label">1. Modal Verbs</span>
                <div class="btn-grid grid-5">
                    <button class="btn-style grammar-btn" onclick="checkAnswer('can', this)">can</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('will', this)">will</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('should', this)">should</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('may', this)">may</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('must', this)">must</button>
                </div>
            </div>

            <div class="group-section">
                <span class="group-label">2. Perfect (Has/Have)</span>
                <div class="btn-grid grid-6">
                    <button class="btn-style grammar-btn" onclick="checkAnswer('have pp', this)">have pp</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('has pp', this)">has pp</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('have been ving', this)">have been ving</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('has been ving', this)">has been ving</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('have been pp', this)">have been pp</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('has been pp', this)">has been pp</button>
                </div>
            </div>

            <div class="group-section">
                <span class="group-label">3. Do/Does/Did</span>
                <div class="btn-grid grid-3">
                    <button class="btn-style grammar-btn" onclick="checkAnswer('do', this)">do</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('does', this)">does</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('did', this)">did</button>
                </div>
            </div>

            <div class="group-section">
                <span class="group-label">4. Is/Are/Are/Was/Were (Is/Am/Are...)</span>
                <div class="btn-grid grid-9">
                    <button class="btn-style grammar-btn" onclick="checkAnswer('is ving', this)">is ving</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('am ving', this)">am ving</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('are ving', this)">are ving</button>
                    
                    <button class="btn-style grammar-btn" onclick="checkAnswer('is pp', this)">is pp</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('am pp', this)">am pp</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('are pp', this)">are pp</button>

                    <button class="btn-style grammar-btn" onclick="checkAnswer('is adj/n', this)">is (adj/n)</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('am adj/n', this)">am (adj/n)</button>
                    <button class="btn-style grammar-btn" onclick="checkAnswer('are adj/n', this)">are (adj/n)</button>
                </div>
            </div>

        </div>

        <div id="feedback-area"></div>
        <button id="next-btn" class="btn-style" onclick="nextQuestion()">Next Question â¡</button>
        <button id="quit-btn" class="btn-style" onclick="returnToMenu()" 
                style="background-color: #fff; border: 2px solid #e9ecef; color: #aaa; font-size: 15px; margin-top: 20px; padding: 10px 20px;">
            â¬… æ”¾æ£„è¿”å› (Quit)
        </button>
    </div>

    <div id="end-screen">
        <div class="final-score">Score: 0</div>
        <div class="error-list" id="error-container"></div>
<div id="end-controls-area" style="width:100%; margin-top:10px;"></div>
    </div>
</div>
<div id="note-modal">
    <div class="note-content">
        <button class="close-note" onclick="closeNote()">Ã—</button>
        <h2 style="text-align:center; color:#5d4037; margin-top:0;">ğŸ“šå¾æœçœŸå•å¥æ‰‹å†ŠğŸ“š</h2>
        
        <div class="formula-box">
            (Wh-word) + æå•å­— + ä¸»èª â€¦â€¦ ?
        </div>

        <div class="note-section" style="background:#fff5f5; border:2px solid #ffc9c9; padding:10px; border-radius:10px;">
            <div class="note-title" style="color:#e03131;">ğŸš« å¸¸çŠ¯ä¸­å¼è‹±æ–‡éŒ¯èª¤</div>
            <div class="note-text">
                1. æª¢æŸ¥ <b>Wh-word æ˜¯å¦ç›´æ¥è·Ÿä¸»èª</b>ï¼Ÿå¦‚æœæ˜¯ï¼Œ<b>99%éŒ¯ï¼</b><br>
                2. å¦‚æœ<b>æ˜¯å¦çœŸå•å¥ç”¨ä¸»èªé–‹é ­</b>ä¹Ÿæ˜¯<b>99%éŒ¯ï¼</b><br>
                <span class="wrong-ex">Why you so stupid?</span> âŒ<br>
                <span class="wrong-ex">He loves me?</span> âŒ
            </div>
        </div>
<h3 style="text-align:center; color:#5d4037; margin: 25px 0 15px 0; border-bottom: 2px dashed #ccc; padding-bottom: 10px; font-size: 20px;">
            ğŸ”» æå•å­—åˆ†é¡
        </h3>
<div class="note-section">
            <div class="note-title"><span class="note-tag">1</span> Modal Verbs (æƒ…æ…‹å‹•è©)</div>
            <div class="note-text">
                å¦‚æœå¥å­æœ‰ä»¥ä¸‹å­—çœ¼ï¼Œç›´æ¥ç”¨å®ƒåšæå•å­—ã€‚<br>
                âš ï¸ <b>æ³¨æ„ï¼š</b>å¾Œé¢çš„å‹•è©å¿…é ˆæ˜¯<b>åŸå‹ (Base Form)</b>ã€‚<br>
                (å¦‚æœå¾Œé¢æ¥åè©/å½¢å®¹è©ï¼Œè¦åŠ  <b>be</b>)
            </div>
            <div class="note-example" style="line-height: 1.8;">
                <b>1. Can (å¯ä»¥/èƒ½å¤ )</b><br>
                ä»–å¯ä»¥è´å‡ºé€™æ¯”è³½å—? â†’ <b>Can</b> he <b>win</b> the game?<br>
                <br>
                <b>2. Will (å°‡æœƒ)</b><br>
                æˆ‘å€‘æœƒå»å“ªè£? â†’ Where <b>will</b> we <b>go</b>?<br>
                <br>
                <b>3. Should (æ‡‰è©²)</b><br>
                æˆ‘å€‘ç¾åœ¨æ‡‰è©²é›¢é–‹å—? â†’ <b>Should</b> we <b>leave</b> now?<br>
                <br>
                <b>4. May (å¯ä»¥/å¯èƒ½ - ç¦®è²Œ)</b><br>
                æˆ‘å¯ä»¥å»æ´—æ‰‹é–“å—? â†’ <b>May</b> I <b>go</b> to the toilet?<br>
                <br>
                <b>5. Must (å¿…é ˆ/ä¸€å®š)</b><br>
                å¥¹ä»Šå¤©å¿…é ˆä¾†å—? â†’ <b>Must</b> she <b>come</b> today?
            </div>
        </div>

        <div class="note-section">
            <div class="note-title"><span class="note-tag">2</span> Has / Have (å®Œæˆå¼)</div>
            <div class="note-text">
                <b>Has</b> (He/She/It) / <b>Have</b> (I/You/We/They)<br>
                <ul>
                    <li>æœ‰ã€Œå·²ç¶“/äº†ã€(ç„¡éå»æ™‚é–“)ï¼šå‹•è©è½‰ <b>pp</b></li>
                    <li>æœ‰ã€Œä¸€ç›´/äº†ã€(æŒçºŒä¸­)ï¼šå‹•è©è½‰ <b>been ving</b></li>
                    <li>æœ‰ã€Œå·²ç¶“è¢«/ä¸€ç›´è¢«ã€ï¼šå‹•è©è½‰ <b>been pp</b></li>
                </ul>
            </div>
            <div class="note-example" style="line-height: 1.8;">
                ä»–å·²ç¶“é›¢é–‹äº†? â†’ <b>Has</b> he <b>left</b>?<br>
                å¥¹ä»Šæ—¥ä¸€ç›´åœ¨åšç”šéº¼? â†’ What <b>has</b> she <b>been doing</b> today?<br>
                ä½ çš„ç‹—å·²ç¶“è¢«æ‰¾å›äº†å—? â†’ <b>Has</b> your dog <b>been found</b>?
            </div>
        </div>

        <div class="note-section">
            <div class="note-title"><span class="note-tag">3</span> Do / Does / Did</div>
            <div class="note-text">
                ç•¶å¥å­<b>æ²’æœ‰</b> Modals åŠ Has/Haveï¼Œåˆæœ‰<b>ä¸»å‹•å‹•è©</b>æ™‚ä½¿ç”¨ã€‚<br>
                âš ï¸ <b>æ³¨æ„ï¼š</b>å¾Œæ–¹å‹•è©å¿…é ˆ<b>åŸå‹</b>ã€‚
                <ul>
                    <li>æœ‰ã€Œéå»æ™‚é–“è©ã€ï¼šç”¨ <b>Did</b></li>
                    <li>ç„¡ç‰¹åˆ¥æ™‚é–“ï¼šç”¨ <b>Do / Does</b></li>
                </ul>
            </div>
            <div class="note-example">
                ä½ è¨å­èœ˜è››å—? â†’ <b>Do</b> you hate spiders?<br>
                ä»–å–œæ­¡ä¸­åœ‹å—? â†’ <b>Does</b> he like China?<br>
                ä½ æ˜¨å¤©é£Ÿäº†ç”šéº¼? â†’ What <b>did</b> you eat yesterday?
            </div>
        </div>
<div class="note-section" style="border-bottom:none;">
            <div class="note-title"><span class="note-tag">4</span> Be Verbs (Is/Am/Are...)</div>
            <div class="note-text">
                ç•¶å¥å­<b>æ²’æœ‰</b>ä¸Šè¿° 1, 2, 3 é¡æƒ…æ³æ™‚ä½¿ç”¨ã€‚<br>
                (éå»æ™‚é–“ç”¨ Was/Wereï¼Œå¦å‰‡ç”¨ Is/Am/Are)
                <ul>
                    <li>æœ‰ã€Œè¢«/ç”±ã€ï¼šå‹•è©è½‰ <b>pp</b></li>
                    <li>æœ‰ã€Œæ­£åœ¨ã€ï¼šå‹•è©è½‰ <b>ing</b></li>
                    <li>åªæœ‰ã€Œå½¢å®¹è©/åè©ã€ï¼šç›´æ¥ç”¨ Be å‹•è©</li>
                </ul>
            </div>
            <div class="note-example">
                ç‚ºç”šéº¼ä»–æ˜¨å¤©è¢«æ‡²ç½°? â†’ Why <b>was</b> he <b>punished</b> yesterday?<br>
                ä½ çš„å®¶åœ¨å“ªè£¡? â†’ Where <b>is</b> your home?<br>
                ä»–å€‘æ­£åœ¨åšç”šéº¼? â†’ What <b>are</b> they <b>doing</b>?<br>
                ä¸­åœ‹100å¹´å‰å¯Œè£•å—? â†’ <b>Was</b> China rich 100 years ago?
            </div>
        </div>

        <button class="btn-style" style="width:100%; background:var(--primary-color); color:white; padding:12px;" onclick="closeNote()">æ˜ç™½ï¼Œé—œé–‰ç­†è¨˜</button>
    </div>
</div>
<script>
    // --- é¡Œç›®è³‡æ–™åº« (æ“´å……è‡³åŒ…å«æ‰€æœ‰é¡å‹) ---
    // cat: 'Modals', 'Perfect', 'DoDid', 'Be'
    const questionBank = [
        // Modals (5)
        { cat: "Modals", ch: "æˆ‘å¯ä»¥å¹«ä½ å—?", ans: "can", en: "<span class='highlight'>Can</span> I help you?", text: "Can I help you?" },
        { cat: "Modals", ch: "ä»–æœƒä¾†å—?", ans: "will", en: "<span class='highlight'>Will</span> he come?", text: "Will he come?" },
        { cat: "Modals", ch: "æˆ‘æ‡‰è©²å‘Šè¨´ä»–å—?", ans: "should", en: "<span class='highlight'>Should</span> I tell him?", text: "Should I tell him?" },
        { cat: "Modals", ch: "æˆ‘å¯ä»¥é€²ä¾†å—? (ç¦®è²Œ)", ans: "may", en: "<span class='highlight'>May</span> I come in?", text: "May I come in?" },
        { cat: "Modals", ch: "é€™å¿…é ˆä»Šå¤©å®Œæˆå—?", ans: "must", en: "<span class='highlight'>Must</span> this be finished today?", text: "Must this be finished today?" },

        // Perfect (6)
        { cat: "Perfect", ch: "ä½ åƒéåˆé¤äº†å—?", ans: "have pp", en: "<span class='highlight'>Have</span> you <span class='highlight'>eaten</span> lunch?", text: "Have you eaten lunch?" },
        { cat: "Perfect", ch: "ä»–å·²ç¶“èµ°äº†å—?", ans: "has pp", en: "<span class='highlight'>Has</span> he <span class='highlight'>left</span>?", text: "Has he left?" },
        { cat: "Perfect", ch: "ä½ ä¸€ç›´éƒ½åœ¨é€™è£¡ç­‰å—?", ans: "have been ving", en: "<span class='highlight'>Have</span> you <span class='highlight'>been waiting</span> here?", text: "Have you been waiting here?" },
        { cat: "Perfect", ch: "ä»–æœ€è¿‘ä¸€ç›´å·¥ä½œå¾ˆè¾›è‹¦å—?", ans: "has been ving", en: "<span class='highlight'>Has</span> he <span class='highlight'>been working</span> hard?", text: "Has he been working hard?" },
        { cat: "Perfect", ch: "é€™äº›æˆ¿å­å·²ç¶“è¢«è³£æ‰äº†å—?", ans: "have been pp", en: "<span class='highlight'>Have</span> these houses <span class='highlight'>been sold</span>?", text: "Have these houses been sold?" },
        { cat: "Perfect", ch: "é€™å°ä¿¡å·²ç¶“è¢«å¯„å‡ºäº†å—?", ans: "has been pp", en: "<span class='highlight'>Has</span> the letter <span class='highlight'>been sent</span>?", text: "Has the letter been sent?" },

        // Do/Did (3)
        { cat: "DoDid", ch: "ä½ å–œæ­¡è²“å—?", ans: "do", en: "<span class='highlight'>Do</span> you like cats?", text: "Do you like cats?" },
        { cat: "DoDid", ch: "ä»–ä½åœ¨é€™å…’å—?", ans: "does", en: "<span class='highlight'>Does</span> he live here?", text: "Does he live here?" },
        { cat: "DoDid", ch: "ä½ æ˜¨å¤©è²·äº†ç”šéº¼?", ans: "did", en: "What <span class='highlight'>did</span> you buy yesterday?", text: "What did you buy yesterday?" },

        // Be (9)
        { cat: "Be", ch: "ä½ æ­£åœ¨è½éŸ³æ¨‚å—?", ans: "are ving", en: "<span class='highlight'>Are</span> you <span class='highlight'>listening</span> to music?", text: "Are you listening to music?" },
        { cat: "Be", ch: "ä»–æ­£åœ¨ç¡è¦ºå—?", ans: "is ving", en: "<span class='highlight'>Is</span> he <span class='highlight'>sleeping</span>?", text: "Is he sleeping?" },
        { cat: "Be", ch: "æˆ‘æ­£åœ¨ç™¼å¤¢å—?", ans: "am ving", en: "<span class='highlight'>Am</span> I <span class='highlight'>dreaming</span>?", text: "Am I dreaming?" },
        { cat: "Be", ch: "ä½ æ˜¯è¢«é‚€è«‹çš„å—?", ans: "are pp", en: "<span class='highlight'>Are</span> you <span class='highlight'>invited</span>?", text: "Are you invited?" },
        { cat: "Be", ch: "é€™æœ¬æ›¸æ˜¯ç”¨è‹±æ–‡å¯«çš„å—?", ans: "is pp", en: "<span class='highlight'>Is</span> this book <span class='highlight'>written</span> in English?", text: "Is this book written in English?" },
        { cat: "Be", ch: "æˆ‘æ˜¯è¢«éœ€è¦çš„å—?", ans: "am pp", en: "<span class='highlight'>Am</span> I <span class='highlight'>needed</span> here?", text: "Am I needed here?" },
        { cat: "Be", ch: "ä½ æ˜¯å­¸ç”Ÿå—?", ans: "are adj/n", en: "<span class='highlight'>Are</span> you a <span class='highlight'>student</span>?", text: "Are you a student?" },
        { cat: "Be", ch: "ä»–å¾ˆé«˜å—?", ans: "is adj/n", en: "<span class='highlight'>Is</span> he <span class='highlight'>tall</span>?", text: "Is he tall?" },
        { cat: "Be", ch: "æˆ‘æ˜¯å°çš„å—?", ans: "am adj/n", en: "<span class='highlight'>Am</span> I <span class='highlight'>right</span>?", text: "Am I right?" },
// --- æ–°å¢ 115 é¡Œ (23åˆ†é¡ x 5é¡Œ) ---
    
    // ==========================================
    // 1. Modals (æƒ…æ…‹å‹•è©)
    // ==========================================
    
    // 1.1 CAN
    { cat: "Modals", ch: "æˆ‘å€‘å¯ä»¥åœ¨å“ªè£¡è²·ç¥¨?", ans: "can", en: "Where <span class='highlight'>can</span> we buy tickets?", text: "Where can we buy tickets?" },
    { cat: "Modals", ch: "ä½ å¯ä»¥ç‚ºæˆ‘åšç”šéº¼?", ans: "can", en: "What <span class='highlight'>can</span> you do for me?", text: "What can you do for me?" },
    { cat: "Modals", ch: "æˆ‘å€‘ä½•æ™‚å¯ä»¥é–‹å§‹?", ans: "can", en: "When <span class='highlight'>can</span> we start?", text: "When can we start?" },
    { cat: "Modals", ch: "æˆ‘è¦å¦‚ä½•æ‰“é–‹é€™å€‹?", ans: "can", en: "How <span class='highlight'>can</span> I open this?", text: "How can I open this?" },
    { cat: "Modals", ch: "ä½ èƒ½è½åˆ°æˆ‘å—?", ans: "can", en: "<span class='highlight'>Can</span> you hear me?", text: "Can you hear me?" },

    // 1.2 WILL
    { cat: "Modals", ch: "ä½ ç”šéº¼æ™‚å€™æœƒå›ä¾†?", ans: "will", en: "When <span class='highlight'>will</span> you return?", text: "When will you return?" },
    { cat: "Modals", ch: "ä»–åœ¨å“ªè£¡ç­‰ä½ ?", ans: "will", en: "Where <span class='highlight'>will</span> he wait for you?", text: "Where will he wait for you?" },
    { cat: "Modals", ch: "èª°æœƒè´å¾—æ¯”è³½?", ans: "will", en: "Who <span class='highlight'>will</span> win the match?", text: "Who will win the match?" },
    { cat: "Modals", ch: "ä½ å°‡æœƒåšç”šéº¼?", ans: "will", en: "What <span class='highlight'>will</span> you do?", text: "What will you do?" },
    { cat: "Modals", ch: "ä½ æœƒå«çµ¦æˆ‘å—?", ans: "will", en: "<span class='highlight'>Will</span> you marry me?", text: "Will you marry me?" },

    // 1.3 SHOULD
    { cat: "Modals", ch: "æˆ‘æ‡‰è©²æŠŠé€™æ”¾åœ¨å“ªè£¡?", ans: "should", en: "Where <span class='highlight'>should</span> I put this?", text: "Where should I put this?" },
    { cat: "Modals", ch: "æˆ‘å€‘ç‚ºä»€éº¼è¦ç›¸ä¿¡ä½ ?", ans: "should", en: "Why <span class='highlight'>should</span> we trust you?", text: "Why should we trust you?" },
    { cat: "Modals", ch: "æˆ‘ä¹Ÿæ‡‰è©²å»å—?", ans: "should", en: "<span class='highlight'>Should</span> I go too?", text: "Should I go too?" },
    { cat: "Modals", ch: "ä»–ç”šéº¼æ™‚å€™åˆ°é”?", ans: "should", en: "When <span class='highlight'>should</span> he arrive?", text: "When should he arrive?" },
    { cat: "Modals", ch: "æˆ‘æ‡‰è©²ç©¿ç”šéº¼?", ans: "should", en: "What <span class='highlight'>should</span> I wear?", text: "What should I wear?" },

    // 1.4 MAY (è¼ƒå°‘ç”¨æ–¼ Wh-å•å¥ï¼Œå¤šè¡¨ç¦®è²Œ/å¯èƒ½)
    { cat: "Modals", ch: "æˆ‘å¯ä»¥åœ¨å“ªè£¡å¸ç…™?", ans: "may", en: "Where <span class='highlight'>may</span> I smoke?", text: "Where may I smoke?" }, // æ¯”è¼ƒæ­£å¼
    { cat: "Modals", ch: "èª°å¯èƒ½çŸ¥é“ç­”æ¡ˆ?", ans: "may", en: "Who <span class='highlight'>may</span> know the answer?", text: "Who may know the answer?" },
    { cat: "Modals", ch: "ç‚ºä»€éº¼é€™å¯èƒ½æ˜¯çœŸçš„?", ans: "may", en: "Why <span class='highlight'>may</span> this be true?", text: "Why may this be true?" },
    { cat: "Modals", ch: "é€™å¯èƒ½å°è‡´ç”šéº¼?", ans: "may", en: "What <span class='highlight'>may</span> this lead to?", text: "What may this lead to?" },
    { cat: "Modals", ch: "æˆ‘å¯ä»¥å€Ÿç”¨ä½ çš„ç­†å—?", ans: "may", en: "<span class='highlight'>May</span> I borrow your pen?", text: "May I borrow your pen?" },

    // 1.5 MUST
    { cat: "Modals", ch: "æˆ‘å€‘å¿…é ˆåœ¨å“ªè£¡ç°½å?", ans: "must", en: "Where <span class='highlight'>must</span> we sign?", text: "Where must we sign?" },
    { cat: "Modals", ch: "ç‚ºä»€éº¼ä½ å¿…é ˆé›¢é–‹?", ans: "must", en: "Why <span class='highlight'>must</span> you leave?", text: "Why must you leave?" },
    { cat: "Modals", ch: "æˆ‘ç”šéº¼æ™‚å€™å¿…é ˆå®Œæˆ?", ans: "must", en: "When <span class='highlight'>must</span> I finish?", text: "When must I finish?" },
    { cat: "Modals", ch: "èª°å¿…é ˆè² è²¬?", ans: "must", en: "Who <span class='highlight'>must</span> be responsible?", text: "Who must be responsible?" },
    { cat: "Modals", ch: "é€™ä¸€å®šæ˜¯çœŸçš„å—? (æ¨æ¸¬)", ans: "must", en: "<span class='highlight'>Must</span> this be true?", text: "Must this be true?" },

    // ==========================================
    // 2. Perfect (å®Œæˆå¼ Have/Has)
    // ==========================================

    // 2.1 HAVE PP
    { cat: "Perfect", ch: "ä½ å»äº†å“ªè£¡?", ans: "have pp", en: "Where <span class='highlight'>have</span> you <span class='highlight'>been</span>?", text: "Where have you been?" },
    { cat: "Perfect", ch: "ä»–å€‘åšäº†ç”šéº¼?", ans: "have pp", en: "What <span class='highlight'>have</span> they <span class='highlight'>done</span>?", text: "What have they done?" },
    { cat: "Perfect", ch: "ä½ ç‚ºä½•æ”¹è®Šäº†ä¸»æ„?", ans: "have pp", en: "Why <span class='highlight'>have</span> you <span class='highlight'>changed</span> your mind?", text: "Why have you changed your mind?" },
    { cat: "Perfect", ch: "ä½ ç­‰äº†å¤šä¹…?", ans: "have pp", en: "How long <span class='highlight'>have</span> you <span class='highlight'>waited</span>?", text: "How long have you waited?" },
    { cat: "Perfect", ch: "ä½ çœ‹éé€™éƒ¨é›»å½±å—?", ans: "have pp", en: "<span class='highlight'>Have</span> you <span class='highlight'>seen</span> this movie?", text: "Have you seen this movie?" },

    // 2.2 HAS PP
    { cat: "Perfect", ch: "ä»–ç™¼ç”Ÿäº†ç”šéº¼äº‹?", ans: "has pp", en: "What <span class='highlight'>has</span> <span class='highlight'>happened</span> to him?", text: "What has happened to him?" },
    { cat: "Perfect", ch: "å¥¹å»äº†å“ªè£¡?", ans: "has pp", en: "Where <span class='highlight'>has</span> she <span class='highlight'>gone</span>?", text: "Where has she gone?" },
    { cat: "Perfect", ch: "èª°æ‹¿èµ°äº†æˆ‘çš„ç­†?", ans: "has pp", en: "Who <span class='highlight'>has</span> <span class='highlight'>taken</span> my pen?", text: "Who has taken my pen?" },
    { cat: "Perfect", ch: "ç‚ºä»€éº¼é›¨åœäº†?", ans: "has pp", en: "Why <span class='highlight'>has</span> the rain <span class='highlight'>stopped</span>?", text: "Why has the rain stopped?" },
    { cat: "Perfect", ch: "ä»–åˆ°é”äº†å—?", ans: "has pp", en: "<span class='highlight'>Has</span> he <span class='highlight'>arrived</span>?", text: "Has he arrived?" },

    // 2.3 HAVE BEEN VING
    { cat: "Perfect", ch: "ä½ æœ€è¿‘ä¸€ç›´åœ¨åšç”šéº¼?", ans: "have been ving", en: "What <span class='highlight'>have</span> you <span class='highlight'>been doing</span> lately?", text: "What have you been doing lately?" },
    { cat: "Perfect", ch: "ä»–å€‘ä¸€ç›´åœ¨å“ªè£¡ç©?", ans: "have been ving", en: "Where <span class='highlight'>have</span> they <span class='highlight'>been playing</span>?", text: "Where have they been playing?" },
    { cat: "Perfect", ch: "ç‚ºä»€éº¼ä½ å€‘ä¸€ç›´åœ¨ç¬‘?", ans: "have been ving", en: "Why <span class='highlight'>have</span> you <span class='highlight'>been laughing</span>?", text: "Why have you been laughing?" },
    { cat: "Perfect", ch: "ä½ å­¸äº†å¤šä¹…è‹±æ–‡?", ans: "have been ving", en: "How long <span class='highlight'>have</span> you <span class='highlight'>been learning</span> English?", text: "How long have you been learning English?" },
    { cat: "Perfect", ch: "ä½ æœ€è¿‘ä¸€ç›´æ„Ÿè¦ºä¸èˆ’æœå—?", ans: "have been ving", en: "<span class='highlight'>Have</span> you <span class='highlight'>been feeling</span> sick?", text: "Have you been feeling sick?" },

    // 2.4 HAS BEEN VING
    { cat: "Perfect", ch: "å¥¹ä¸€ç›´åœ¨å’Œèª°èªªè©±?", ans: "has been ving", en: "Who <span class='highlight'>has</span> she <span class='highlight'>been talking</span> to?", text: "Who has she been talking to?" },
    { cat: "Perfect", ch: "ä»–ä¸€ç›´åœ¨å“ªè£¡å·¥ä½œ?", ans: "has been ving", en: "Where <span class='highlight'>has</span> he <span class='highlight'>been working</span>?", text: "Where has he been working?" },
    { cat: "Perfect", ch: "é€™ç‹—ä¸€ç›´åœ¨å«ç”šéº¼?", ans: "has been ving", en: "What <span class='highlight'>has</span> the dog <span class='highlight'>been barking</span> at?", text: "What has the dog been barking at?" },
    { cat: "Perfect", ch: "ç‚ºä»€éº¼ä¸€ç›´åœ¨ä¸‹é›¨?", ans: "has been ving", en: "Why <span class='highlight'>has</span> it <span class='highlight'>been raining</span>?", text: "Why has it been raining?" },
    { cat: "Perfect", ch: "ä»–æœ€è¿‘ä¸€ç›´ç¡å¾—å¥½å—?", ans: "has been ving", en: "<span class='highlight'>Has</span> he <span class='highlight'>been sleeping</span> well?", text: "Has he been sleeping well?" },

    // 2.5 HAVE BEEN PP
    { cat: "Perfect", ch: "é€™äº›è»Šæ˜¯åœ¨å“ªè£¡è£½é€ çš„?", ans: "have been pp", en: "Where <span class='highlight'>have</span> these cars <span class='highlight'>been made</span>?", text: "Where have these cars been made?" },
    { cat: "Perfect", ch: "ç”šéº¼è¦å‰‡è¢«æ”¹è®Šäº†?", ans: "have been pp", en: "What rules <span class='highlight'>have</span> <span class='highlight'>been changed</span>?", text: "What rules have been changed?" },
    { cat: "Perfect", ch: "ç‚ºä»€éº¼èˆªç­è¢«å–æ¶ˆäº†?", ans: "have been pp", en: "Why <span class='highlight'>have</span> the flights <span class='highlight'>been cancelled</span>?", text: "Why have the flights been cancelled?" },
    { cat: "Perfect", ch: "é€™äº›æˆ¿é–“ä½•æ™‚è¢«æ¸…æ½”é?", ans: "have been pp", en: "When <span class='highlight'>have</span> the rooms <span class='highlight'>been cleaned</span>?", text: "When have the rooms been cleaned?" },
    { cat: "Perfect", ch: "ä»–å€‘è¢«é€šçŸ¥äº†å—?", ans: "have been pp", en: "<span class='highlight'>Have</span> they <span class='highlight'>been informed</span>?", text: "Have they been informed?" },

    // 2.6 HAS BEEN PP
    { cat: "Perfect", ch: "æˆ‘çš„éŒ¢åŒ…è¢«å·å»å“ªäº†?", ans: "has been pp", en: "Where <span class='highlight'>has</span> my wallet <span class='highlight'>been stolen</span>?", text: "Where has my wallet been stolen?" },
    { cat: "Perfect", ch: "ç”šéº¼è¢«ç™¼ç¾äº†?", ans: "has been pp", en: "What <span class='highlight'>has</span> <span class='highlight'>been discovered</span>?", text: "What has been discovered?" },
    { cat: "Perfect", ch: "ç‚ºä»€éº¼æœƒè­°è¢«æ¨é²äº†?", ans: "has been pp", en: "Why <span class='highlight'>has</span> the meeting <span class='highlight'>been delayed</span>?", text: "Why has the meeting been delayed?" },
    { cat: "Perfect", ch: "é€™æˆ¿å­æ˜¯ä½•æ™‚å»ºæˆçš„?", ans: "has been pp", en: "When <span class='highlight'>has</span> this house <span class='highlight'>been built</span>?", text: "When has this house been built?" },
    { cat: "Perfect", ch: "å®ƒè¢«ä¿®ç†å¥½äº†å—?", ans: "has been pp", en: "<span class='highlight'>Has</span> it <span class='highlight'>been fixed</span>?", text: "Has it been fixed?" },

    // ==========================================
    // 3. Do / Does / Did (Simple Tense)
    // ==========================================

    // 3.1 DO
    { cat: "DoDid", ch: "ä½ æƒ³è¦ç”šéº¼?", ans: "do", en: "What <span class='highlight'>do</span> you want?", text: "What do you want?" },
    { cat: "DoDid", ch: "ä»–å€‘ä»€éº¼æ™‚å€™é›¢é–‹?", ans: "do", en: "When <span class='highlight'>do</span> they leave?", text: "When do they leave?" },
    { cat: "DoDid", ch: "ä½ ä½åœ¨å“ªè£¡?", ans: "do", en: "Where <span class='highlight'>do</span> you live?", text: "Where do you live?" },
    { cat: "DoDid", ch: "æˆ‘å€‘ç‚ºä»€éº¼éœ€è¦é€™å€‹?", ans: "do", en: "Why <span class='highlight'>do</span> we need this?", text: "Why do we need this?" },
    { cat: "DoDid", ch: "ä½ æ˜ç™½å—?", ans: "do", en: "<span class='highlight'>Do</span> you understand?", text: "Do you understand?" },

    // 3.2 DOES
    { cat: "DoDid", ch: "é€™æ„å‘³è‘—ç”šéº¼?", ans: "does", en: "What <span class='highlight'>does</span> this mean?", text: "What does this mean?" },
    { cat: "DoDid", ch: "ä»–ç”šéº¼æ™‚å€™é–‹å§‹?", ans: "does", en: "When <span class='highlight'>does</span> he start?", text: "When does he start?" },
    { cat: "DoDid", ch: "å¥¹ä½åœ¨å“ªè£¡?", ans: "does", en: "Where <span class='highlight'>does</span> she live?", text: "Where does she live?" },
    { cat: "DoDid", ch: "ç‚ºä»€éº¼é€™å¾ˆç—›?", ans: "does", en: "Why <span class='highlight'>does</span> it hurt?", text: "Why does it hurt?" },
    { cat: "DoDid", ch: "ä»–èªè­˜ä½ å—?", ans: "does", en: "<span class='highlight'>Does</span> he know you?", text: "Does he know you?" },

    // 3.3 DID
    { cat: "DoDid", ch: "ä½ æ˜¨å¤©çœ‹è¦‹äº†ç”šéº¼?", ans: "did", en: "What <span class='highlight'>did</span> you see yesterday?", text: "What did you see yesterday?" },
    { cat: "DoDid", ch: "ä»–å€‘ç”šéº¼æ™‚å€™åˆ°é”çš„?", ans: "did", en: "When <span class='highlight'>did</span> they arrive?", text: "When did they arrive?" },
    { cat: "DoDid", ch: "ä½ æŠŠé‘°åŒ™æ”¾å“ªäº†?", ans: "did", en: "Where <span class='highlight'>did</span> you put the keys?", text: "Where did you put the keys?" },
    { cat: "DoDid", ch: "ä½ ç‚ºä»€éº¼å“­?", ans: "did", en: "Why <span class='highlight'>did</span> you cry?", text: "Why did you cry?" },
    { cat: "DoDid", ch: "ä½ å–œæ­¡é€™é›»å½±å—?", ans: "did", en: "<span class='highlight'>Did</span> you like the movie?", text: "Did you like the movie?" },

    // ==========================================
    // 4. Be Verbs (Is/Am/Are...)
    // ==========================================

    // 4.1 IS VING (Present Continuous - Singular)
    { cat: "Be", ch: "ä»–åœ¨åšç”šéº¼?", ans: "is ving", en: "What <span class='highlight'>is</span> he <span class='highlight'>doing</span>?", text: "What is he doing?" },
    { cat: "Be", ch: "å¥¹è¦å»å“ªè£¡?", ans: "is ving", en: "Where <span class='highlight'>is</span> she <span class='highlight'>going</span>?", text: "Where is she going?" },
    { cat: "Be", ch: "èª°åœ¨ç¡è¦º?", ans: "is ving", en: "Who <span class='highlight'>is</span> <span class='highlight'>sleeping</span>?", text: "Who is sleeping?" },
    { cat: "Be", ch: "ç‚ºä»€éº¼ä»–åœ¨è·‘?", ans: "is ving", en: "Why <span class='highlight'>is</span> he <span class='highlight'>running</span>?", text: "Why is he running?" },
    { cat: "Be", ch: "æ­£åœ¨ä¸‹é›¨å—?", ans: "is ving", en: "<span class='highlight'>Is</span> it <span class='highlight'>raining</span>?", text: "Is it raining?" },

    // 4.2 AM VING (Present Continuous - I)
    { cat: "Be", ch: "æˆ‘æ­£åœ¨åšç”šéº¼?", ans: "am ving", en: "What <span class='highlight'>am</span> I <span class='highlight'>doing</span>?", text: "What am I doing?" },
    { cat: "Be", ch: "æˆ‘ç‚ºä»€éº¼åœ¨ç­‰å¾…?", ans: "am ving", en: "Why <span class='highlight'>am</span> I <span class='highlight'>waiting</span>?", text: "Why am I waiting?" },
    { cat: "Be", ch: "æˆ‘è¦å»å“ªè£¡?", ans: "am ving", en: "Where <span class='highlight'>am</span> I <span class='highlight'>going</span>?", text: "Where am I going?" },
    { cat: "Be", ch: "æˆ‘å’Œèª°èªªè©±?", ans: "am ving", en: "Who <span class='highlight'>am</span> I <span class='highlight'>talking</span> to?", text: "Who am I talking to?" },
    { cat: "Be", ch: "æˆ‘æ­£åœ¨ç™¼å¤¢å—?", ans: "am ving", en: "<span class='highlight'>Am</span> I <span class='highlight'>dreaming</span>?", text: "Am I dreaming?" },

    // 4.3 ARE VING (Present Continuous - Plural)
    { cat: "Be", ch: "ä½ å€‘åœ¨çœ‹ç”šéº¼?", ans: "are ving", en: "What <span class='highlight'>are</span> you <span class='highlight'>watching</span>?", text: "What are you watching?" },
    { cat: "Be", ch: "ä»–å€‘å»å“ªè£¡?", ans: "are ving", en: "Where <span class='highlight'>are</span> they <span class='highlight'>going</span>?", text: "Where are they going?" },
    { cat: "Be", ch: "ç‚ºä»€éº¼ä½ å€‘åœ¨ç¬‘?", ans: "are ving", en: "Why <span class='highlight'>are</span> you <span class='highlight'>laughing</span>?", text: "Why are you laughing?" },
    { cat: "Be", ch: "æˆ‘å€‘ç”šéº¼æ™‚å€™é›¢é–‹?", ans: "are ving", en: "When <span class='highlight'>are</span> we <span class='highlight'>leaving</span>?", text: "When are we leaving?" },
    { cat: "Be", ch: "ä½ åœ¨é–‹ç©ç¬‘å—?", ans: "are ving", en: "<span class='highlight'>Are</span> you <span class='highlight'>kidding</span>?", text: "Are you kidding?" },

    // 4.4 IS PP (Passive - Singular)
    { cat: "Be", ch: "é€™å«ç”šéº¼åå­—?", ans: "is pp", en: "What <span class='highlight'>is</span> this <span class='highlight'>called</span>?", text: "What is this called?" },
    { cat: "Be", ch: "å®ƒæ˜¯åœ¨å“ªè£¡è£½é€ çš„?", ans: "is pp", en: "Where <span class='highlight'>is</span> it <span class='highlight'>made</span>?", text: "Where is it made?" },
    { cat: "Be", ch: "åƒåœ¾ç”šéº¼æ™‚å€™è¢«æ”¶é›†?", ans: "is pp", en: "When <span class='highlight'>is</span> the trash <span class='highlight'>collected</span>?", text: "When is the trash collected?" },
    { cat: "Be", ch: "ç‚ºä»€éº¼å®ƒè¢«ç¦æ­¢?", ans: "is pp", en: "Why <span class='highlight'>is</span> it <span class='highlight'>forbidden</span>?", text: "Why is it forbidden?" },
    { cat: "Be", ch: "é€™åº§ä½è¢«ä½”ç”¨äº†å—?", ans: "is pp", en: "<span class='highlight'>Is</span> this seat <span class='highlight'>taken</span>?", text: "Is this seat taken?" },

    // 4.5 AM PP (Passive - I)
    { cat: "Be", ch: "æˆ‘ç‚ºä»€éº¼è¢«é¸ä¸­?", ans: "am pp", en: "Why <span class='highlight'>am</span> I <span class='highlight'>chosen</span>?", text: "Why am I chosen?" },
    { cat: "Be", ch: "æˆ‘åœ¨å“ªè£¡è¢«éœ€è¦?", ans: "am pp", en: "Where <span class='highlight'>am</span> I <span class='highlight'>needed</span>?", text: "Where am I needed?" },
    { cat: "Be", ch: "æˆ‘ä½•æ™‚è¢«å…è¨±é›¢é–‹?", ans: "am pp", en: "When <span class='highlight'>am</span> I <span class='highlight'>allowed</span> to leave?", text: "When am I allowed to leave?" },
    { cat: "Be", ch: "æˆ‘è©²æ€éº¼è¢«ç¨±å‘¼?", ans: "am pp", en: "How <span class='highlight'>am</span> I <span class='highlight'>addressed</span>?", text: "How am I addressed?" },
    { cat: "Be", ch: "æˆ‘æ˜¯è¢«é‚€è«‹çš„å—?", ans: "am pp", en: "<span class='highlight'>Am</span> I <span class='highlight'>invited</span>?", text: "Am I invited?" },

    // 4.6 ARE PP (Passive - Plural)
    { cat: "Be", ch: "é€™äº›æ˜¯ç”¨ç”šéº¼åšçš„?", ans: "are pp", en: "What <span class='highlight'>are</span> these <span class='highlight'>made</span> of?", text: "What are these made of?" },
    { cat: "Be", ch: "é€™äº›è˜‹æœåœ¨å“ªè£¡ç¨®æ¤çš„?", ans: "are pp", en: "Where <span class='highlight'>are</span> these apples <span class='highlight'>grown</span>?", text: "Where are these apples grown?" },
    { cat: "Be", ch: "å•†åº—ç”šéº¼æ™‚å€™é—œé–€?", ans: "are pp", en: "When <span class='highlight'>are</span> the shops <span class='highlight'>closed</span>?", text: "When are the shops closed?" },
    { cat: "Be", ch: "ç‚ºä»€éº¼ä»–å€‘è¢«æ‡²ç½°?", ans: "are pp", en: "Why <span class='highlight'>are</span> they <span class='highlight'>punished</span>?", text: "Why are they punished?" },
    { cat: "Be", ch: "ä½ å€‘æº–å‚™å¥½äº†å—?", ans: "are pp", en: "<span class='highlight'>Are</span> you <span class='highlight'>prepared</span>?", text: "Are you prepared?" },

    // 4.7 IS ADJ/N (State - Singular)
    { cat: "Be", ch: "é€™æ˜¯ç”šéº¼?", ans: "is adj/n", en: "What <span class='highlight'>is</span> this?", text: "What is this?" },
    { cat: "Be", ch: "æ´—æ‰‹é–“åœ¨å“ªè£¡?", ans: "is adj/n", en: "Where <span class='highlight'>is</span> the restroom?", text: "Where is the restroom?" },
    { cat: "Be", ch: "ä»–çš„ç”Ÿæ—¥æ˜¯ä½•æ™‚?", ans: "is adj/n", en: "When <span class='highlight'>is</span> his birthday?", text: "When is his birthday?" },
    { cat: "Be", ch: "èª°æ˜¯ä½ çš„è€å¸«?", ans: "is adj/n", en: "Who <span class='highlight'>is</span> your teacher?", text: "Who is your teacher?" },
    { cat: "Be", ch: "ä»–å¾ˆé«˜èˆˆå—?", ans: "is adj/n", en: "<span class='highlight'>Is</span> he happy?", text: "Is he happy?" },

    // 4.8 AM ADJ/N (State - I)
    { cat: "Be", ch: "æˆ‘åœ¨å“ªè£¡?", ans: "am adj/n", en: "Where <span class='highlight'>am</span> I?", text: "Where am I?" },
    { cat: "Be", ch: "æˆ‘æ˜¯èª°?", ans: "am adj/n", en: "Who <span class='highlight'>am</span> I?", text: "Who am I?" },
    { cat: "Be", ch: "ç‚ºä»€éº¼æˆ‘é€™éº¼ç´¯?", ans: "am adj/n", en: "Why <span class='highlight'>am</span> I so tired?", text: "Why am I so tired?" },
    { cat: "Be", ch: "æˆ‘å¤šå¤§äº†?", ans: "am adj/n", en: "How old <span class='highlight'>am</span> I?", text: "How old am I?" },
    { cat: "Be", ch: "æˆ‘é²åˆ°äº†å—?", ans: "am adj/n", en: "<span class='highlight'>Am</span> I late?", text: "Am I late?" },

    // 4.9 ARE ADJ/N (State - Plural)
    { cat: "Be", ch: "é‚£äº›æ˜¯ç”šéº¼?", ans: "are adj/n", en: "What <span class='highlight'>are</span> those?", text: "What are those?" },
    { cat: "Be", ch: "æˆ‘çš„é‘°åŒ™åœ¨å“ªè£¡?", ans: "are adj/n", en: "Where <span class='highlight'>are</span> my keys?", text: "Where are my keys?" },
    { cat: "Be", ch: "ä½ å€‘ç”šéº¼æ™‚å€™æœ‰ç©º?", ans: "are adj/n", en: "When <span class='highlight'>are</span> you free?", text: "When are you free?" },
    { cat: "Be", ch: "èª°æ˜¯ä½ çš„çˆ¶æ¯?", ans: "are adj/n", en: "Who <span class='highlight'>are</span> your parents?", text: "Who are your parents?" },
    { cat: "Be", ch: "ä½ é¤“äº†å—?", ans: "are adj/n", en: "<span class='highlight'>Are</span> you hungry?", text: "Are you hungry?" }
    ];

    // éŸ³æ•ˆ
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const sfx = {
        playTone: (f, t, d, v=0.1) => {
            if(audioContext.state==='suspended') audioContext.resume();
            const o=audioContext.createOscillator(); const g=audioContext.createGain();
            o.connect(g); g.connect(audioContext.destination);
            o.type=t; o.frequency.value=f;
            g.gain.setValueAtTime(v, audioContext.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime+d);
            o.start(); o.stop(audioContext.currentTime+d);
        },
        // ä¸€èˆ¬é»æ“Š
        click: () => sfx.playTone(600, 'triangle', 0.05, 0.2),
        // âœ… æ–°å¢ï¼šé–‹é—œæ£è² (çŸ­ä¿ƒæ¸…è„†)
        toggle: () => sfx.playTone(1200, 'sine', 0.03, 0.1),
        // âœ… æ–°å¢ï¼šè¶…ç´šæŒ¯å¥®é–‹å§‹è² (ç™»-ç™»-ç™»-ç™»ï¼)
        startHyper: () => {
            // C5 -> E5 -> G5 -> C6 (Squareæ³¢å½¢æ›´æœ‰8-bitéŠæˆ²æ„Ÿ)
            sfx.playTone(523.25, 'square', 0.1, 0.1); 
            setTimeout(() => sfx.playTone(659.25, 'square', 0.1, 0.1), 80); 
            setTimeout(() => sfx.playTone(783.99, 'square', 0.1, 0.1), 160); 
            setTimeout(() => sfx.playTone(1046.50, 'square', 0.3, 0.1), 240); 
        },
        correct: () => { sfx.playTone(880, 'sine', 0.1); setTimeout(()=>sfx.playTone(1760, 'sine', 0.2), 100); },
        wrong: () => { sfx.playTone(150, 'sawtooth', 0.3, 0.3); }
    };

    // è®Šæ•¸
    let currentQ = 0;
    let score = 0;
    let questions = [];
    let wrongAnswers = [];
    let isAnswering = false;
    let timerInterval;
    let timeLeft = 15;
    let totalQuestions = 10;

    function updateSlider(val) {
        totalQuestions = parseInt(val);
        document.getElementById('q-count-display').innerText = val;
    }

// âœ… ä¿®æ”¹å¾Œçš„ startGame (æ”¯æ´é‡åšéŒ¯é¡Œ)
    function startGame(retryMode = false) {
        // ğŸ”Š æ’­æ”¾ Hyper éŸ³æ•ˆ (é‡åšæ™‚éƒ½æœƒæ’­)
        if(sfx && sfx.startHyper) sfx.startHyper();

        let newQuestions = [];

        if (retryMode) {
            // --- ğŸ” é‡åšæ¨¡å¼ ---
            // ç›´æ¥ä½¿ç”¨ä¸Šä¸€å±€çš„éŒ¯é¡Œä½œç‚ºæ–°é¡Œç›®
            newQuestions = [...wrongAnswers];
            
            // éš¨æ©Ÿæ´—ç‰Œ (å¯é¸)
            newQuestions.sort(() => 0.5 - Math.random());
            
        } else {
            // --- ğŸ†• æ–°éŠæˆ²æ¨¡å¼ (åŸæœ¬çš„é‚è¼¯) ---
            
            // 1. ç²å–å‹¾é¸çš„é¡åˆ¥
            const selectedCats = Array.from(document.querySelectorAll('input[name="cat"]:checked')).map(el => el.value);
            if (selectedCats.length === 0) {
                alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é¡åˆ¥ï¼");
                return;
            }

            // 2. ç²å–é¡Œç›®æ•¸é‡
            const slider = document.getElementById('q-slider');
            const qCount = slider ? parseInt(slider.value) : 10;

            // 3. ç¯©é¸é¡Œç›®
            let pool = questionBank.filter(q => selectedCats.includes(q.cat));
            if (pool.length === 0) {
                alert("é¡Œåº«ä¸­æ²’æœ‰ç¬¦åˆè©²é¡åˆ¥çš„é¡Œç›®ï¼");
                return;
            }

            // 4. éš¨æ©Ÿé¸é¡Œ
            let tempPool = [...pool];
            for(let i=0; i<qCount; i++) {
                 if(tempPool.length === 0) tempPool = [...pool];
                 const r = Math.floor(Math.random() * tempPool.length);
                 newQuestions.push(tempPool[r]);
                 tempPool.splice(r, 1);
            }
        }
        
        // 5. åˆå§‹åŒ–éŠæˆ²ç‹€æ…‹
        questions = newQuestions;
        totalQuestions = questions.length;
        score = 0;
        currentQ = 0;
        wrongAnswers = []; // æ¸…ç©ºéŒ¯é¡Œè¨˜éŒ„ï¼Œæº–å‚™è¨˜éŒ„é€™ä¸€å±€çš„æ–°éŒ¯é¡Œ
        
        // 6. ä»‹é¢åˆ‡æ›
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('end-screen').style.display = 'none';
        document.getElementById('game-area').style.display = 'flex';
        
        loadQuestion();
    }

    function loadQuestion() {
        isAnswering = true;
        const q = questions[currentQ];
        
        // UI æ›´æ–°
        document.getElementById('score-display').innerText = `Score: ${score}`;
        document.getElementById('q-num-display').innerText = `Q: ${currentQ + 1}/${totalQuestions}`;
        document.getElementById('ch-sentence').innerText = q.ch;
        document.getElementById('feedback-area').innerHTML = '';
        document.getElementById('next-btn').style.display = 'none';
        
        // æŒ‰éˆ•é‡ç½®
        document.querySelectorAll('.grammar-btn').forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('correct', 'wrong');
            btn.style.opacity = '1';
        });

        startTimer();
    }

    function startTimer() {
        clearInterval(timerInterval);
        timeLeft = 15; // æ¯é¡Œ 15 ç§’
        updateTimerUI();
        
        timerInterval = setInterval(() => {
            timeLeft -= 0.1;
            if (timeLeft <= 0) {
                timeLeft = 0;
                timeUp();
            }
            updateTimerUI();
        }, 100);
    }

    function updateTimerUI() {
        const bar = document.getElementById('timer-bar');
        const text = document.getElementById('timer-text');
        const pct = (timeLeft / 15) * 100;
        
        bar.style.width = pct + '%';
        text.innerText = timeLeft.toFixed(1);

        // è®Šè‰²é‚è¼¯
        if (pct > 50) {
            bar.style.backgroundColor = 'var(--primary-color)';
        } else if (pct > 20) {
            bar.style.backgroundColor = 'var(--warning-color)';
        } else {
            bar.style.backgroundColor = 'var(--danger-color)';
        }
    }

    function timeUp() {
        clearInterval(timerInterval);
        if (!isAnswering) return;
        
        // ç•¶ä½œç­”éŒ¯è™•ç†
        isAnswering = false;
        const q = questions[currentQ];
        sfx.wrong();
        wrongAnswers.push({...q, userAns: "Time's up"});
        showFeedback(false, q.en, q.text, q.ans);
        
        // é–å®šæŒ‰éˆ•
        document.querySelectorAll('.grammar-btn').forEach(btn => btn.disabled = true);
        document.getElementById('next-btn').style.display = 'block';
    }

    function checkAnswer(userChoice, btnElement) {
        if (!isAnswering) return;
        isAnswering = false;
        clearInterval(timerInterval);

        const q = questions[currentQ];
        const isCorrect = (userChoice === q.ans);

        // é–å®šæ‰€æœ‰æŒ‰éˆ•
        document.querySelectorAll('.grammar-btn').forEach(btn => {
            btn.disabled = true;
            if (btn !== btnElement) btn.style.opacity = '0.5';
        });

        if (isCorrect) {
            score++;
            sfx.correct();
            btnElement.classList.add('correct');
            showFeedback(true, q.en, q.text);
        } else {
            sfx.wrong();
            btnElement.classList.add('wrong');
            wrongAnswers.push({...q, userAns: userChoice});
            
            // æç¤ºæ­£ç¢ºç­”æ¡ˆçš„æŒ‰éˆ• (è¦–è¦ºè¼”åŠ©)
            document.querySelectorAll('.grammar-btn').forEach(btn => {
                // ç”¨ onclick çš„å­—ä¸²å…§å®¹ä¾†æ¯”å°æœ‰é» trickyï¼Œé€™è£¡ç°¡å–®ç•¥éï¼Œç›´æ¥çœ‹ Feedback
                // ç‚ºäº†ç²¾ç¢ºï¼Œæˆ‘å€‘æ¯”å° innerText
                const btnText = btn.innerText.trim();
                // é€™è£¡ç°¡åŒ–è™•ç†ï¼Œå› ç‚º innerText å¯èƒ½å’Œ ans ä¸å®Œå…¨ä¸€æ¨£ (ä¾‹å¦‚ is (adj/n) vs is adj/n)
                // å»ºè­°ä¾é  Feedback é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            });

            showFeedback(false, q.en, q.text, q.ans);
        }

        document.getElementById('score-display').innerText = `Score: ${score}`;
        document.getElementById('next-btn').style.display = 'block';
    }

// --- ä¿®æ”¹å¾Œçš„ ShowFeedback (åŠ å…¥è·Ÿè®€åŠŸèƒ½) ---
    function showFeedback(correct, htmlSentence, rawSentence, correctAnsText = "") {
        const area = document.getElementById('feedback-area');
        const colorClass = correct ? 'feedback-correct' : 'feedback-wrong';
        const msg = correct ? 'Bingo! æ­£ç¢º!' : `Oops! æ‡‰é¸: ${correctAnsText}`;
        
        // è¨­å®šå…¨åŸŸè®Šæ•¸ï¼Œä¾›è©•åˆ†ä½¿ç”¨
        currentTargetText = rawSentence;

        // è™•ç†å–®å¼•è™Ÿ
        const safeSentence = rawSentence.replace(/'/g, "\\'");

        area.innerHTML = `
            <div class="feedback-card ${colorClass}">
                <div style="font-size:16px; font-weight:bold; color:#555; margin-bottom:5px;">${msg}</div>
                
                <div class="en-sentence-reveal" style="display:flex; align-items:center; justify-content:center; gap:8px;">
                    <span>${htmlSentence}</span>
                    <span onclick="speak('${safeSentence}')" style="cursor:pointer; font-size:24px; transition:transform 0.2s;" onmousedown="this.style.transform='scale(0.9)'" onmouseup="this.style.transform='scale(1)'" title="è½ç™¼éŸ³">
                        ğŸ”Š
                    </span>
                </div>

                <div id="sentence-mic-area" style="border-top:2px dashed #ddd; padding-top:10px; margin-top:10px;">
                    <button id="mic-btn" class="mic-btn" onclick="toggleMic()" disabled>
                        <span>ğŸ¤</span> <span id="mic-status">è«‹ç¨å€™... (æ­£åœ¨æ’­æ”¾)</span>
                    </button>
                    <div id="mic-feedback" class="mic-result"></div>
                </div>
            </div>
        `;
        
        // æ’­æ”¾èªéŸ³ï¼ŒåŠ å…¥ callbackï¼Œè®€å®Œå¾Œè§£é–æŒ‰éˆ•
        speak(rawSentence, () => {
            const btn = document.getElementById('mic-btn');
            const status = document.getElementById('mic-status');
            if(btn) {
                btn.disabled = false;
                if(status) status.innerText = "è·Ÿè®€é€™å¥ (è©•åˆ†)";
            }
        });
    }

    // --- ä¿®æ”¹å¾Œçš„ Speak (æ”¯æ´ Callback) ---
    function speak(text, onEndCallback) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'en-US';
            u.rate = 0.9;
            
            // è®€å®Œå¾ŒåŸ·è¡Œ
            u.onend = function() {
                if (onEndCallback) onEndCallback();
            };
            // å‡ºéŒ¯ä¹ŸåŸ·è¡Œ (é¿å…æŒ‰éˆ•é–æ­»)
            u.onerror = function() {
                if (onEndCallback) onEndCallback();
            };
            
            window.speechSynthesis.speak(u);
        } else {
            // ä¸æ”¯æ´èªéŸ³æ™‚ç›´æ¥ callback
            if (onEndCallback) onEndCallback();
        }
    }

    function nextQuestion() {
        currentQ++;
        if (currentQ < questions.length) {
            loadQuestion();
        } else {
            endGame();
        }
    }
// --- éŠæˆ²ä¸­é€”è¿”å›åŠŸèƒ½ ---
    function returnToMenu() {
        if(confirm("ç¢ºå®šè¦æ”¾æ£„ä¸¦è¿”å›ä¸»é¸å–®å—ï¼Ÿ\n(ç›®å‰çš„é€²åº¦å°‡æœƒéºå¤±)")) {
            // 1. åœæ­¢éŠæˆ²ç›¸é—œé‹ä½œ
            clearInterval(timerInterval);
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
            
            // 2. åˆ‡æ›ä»‹é¢
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('end-screen').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            
            // 3. é‡ç½®ç‹€æ…‹ (å¯é¸ï¼Œè¦–ä¹ startGame æœ‰ç„¡åšï¼Œä½†ä¿éšªèµ·è¦‹æ¸…ç©º)
            isAnswering = false;
        }
    }
function endGame() {
        document.getElementById('game-area').style.display = 'none';
        document.getElementById('end-screen').style.display = 'flex';
        document.querySelector('.final-score').innerText = `Score: ${score} / ${questions.length}`;
        
        const errContainer = document.getElementById('error-container');
        errContainer.innerHTML = '';
        
        // é¡¯ç¤ºéŒ¯é¡Œåˆ—è¡¨
        if (wrongAnswers.length > 0) {
            errContainer.innerHTML = `<div style="font-weight:bold; margin-bottom:10px;">éŒ¯é¡Œé‡æº« (${wrongAnswers.length}é¡Œ):</div>`;
            wrongAnswers.forEach(q => {
                errContainer.innerHTML += `
                    <div class="error-item">
                        <div style="font-weight:bold;">${q.ch}</div>
                        <div style="color:var(--primary-dark); font-size:14px;">${q.text}</div>
                        <div style="font-size:12px; color:#888;">Ans: ${q.ans}</div>
                    </div>
                `;
            });
        } else {
            errContainer.innerHTML = '<div style="text-align:center; color:var(--correct-color); font-weight:bold; font-size:18px;">å®Œç¾å…¨å°ï¼Excellent! ğŸ‰</div>';
        }

        // ğŸ‘‡ ç”Ÿæˆåº•éƒ¨æŒ‰éˆ• (æ ¹æ“šæ˜¯å¦æœ‰éŒ¯é¡Œé¡¯ç¤ºä¸åŒæŒ‰éˆ•)
        // é€™è£¡åƒç…§äº† index(11) çš„çµæ§‹å’Œæ¨£å¼
        const retryDisplay = wrongAnswers.length > 0 ? 'inline-block' : 'none';
        
        // æ‰¾åˆ°åŸæœ¬æ”¾æŒ‰éˆ•çš„ div (å‡è¨­ä½ åœ¨ HTML è£¡å·²ç¶“æœ‰ä¸€å€‹ div åŒ…ä½æŒ‰éˆ•)
        // ç‚ºäº†æ–¹ä¾¿ï¼Œæˆ‘å€‘ç›´æ¥é‡æ–°å¯«å…¥æ•´å€‹æŒ‰éˆ•å€åŸŸ
        // è«‹ç¢ºä¿ä½ çš„ HTML è£¡ï¼Œend-screen æœ€åº•éƒ¨çš„é‚£å€‹ div class å« "end-controls" æˆ–è€…ç›´æ¥ç”¨ style æ›¿æ›
        
        // å¦‚æœä½ åŸæœ¬çš„ HTML æ˜¯ <div style="display:flex; gap:10px; ...">ï¼Œè«‹çµ¦å®ƒä¸€å€‹ ID ä¾‹å¦‚ id="end-btn-area" æ–¹ä¾¿æ§åˆ¶
        // æ—¢ç„¶è¦ "å­¸ index(11)"ï¼Œæˆ‘å»ºè­°ç›´æ¥ç”¨ JS è¦†è“‹é‚£å¡Šå€åŸŸï¼š
        
        const controlsHtml = `
            <div style="display:flex; gap:10px; width:100%; justify-content:center; flex-wrap:wrap;">
                <button class="btn-style big-start-btn" 
                        style="flex:1; min-width:120px; background:#fff; border:2px solid #ccc; color:#555; white-space:nowrap;" 
                        onclick="location.reload()">
                    è¿”å›è¨­å®š
                </button>
                
                <button class="btn-style big-start-btn" 
                        style="display:${retryDisplay}; flex:1; min-width:120px; background-color:#ffecc7; color:#d97706; border:2px dashed #d97706; white-space:nowrap;" 
                        onclick="startGame(true)">
                    é‡åšéŒ¯é¡Œ
                </button>

                <button class="btn-style big-start-btn" 
                        style="flex:1; min-width:120px; white-space:nowrap;" 
                        onclick="startGame(false)">
                    å†ç©ä¸€æ¬¡
                </button>
            </div>
        `;
        
        // é€™è£¡éœ€è¦ä½ ç¢ºèªä¸€ä¸‹ HTML çµæ§‹ã€‚
        // æœ€ç°¡å–®çš„æ–¹æ³•æ˜¯ï¼šåœ¨ end-screen æœ€å¾Œé¢æ”¾ä¸€å€‹ç©ºçš„ <div id="end-controls-area"></div>
        // ç„¶å¾Œé€™è£¡ç”¨ innerHTML å¡«å…¥å»ã€‚
        
        // å‡è¨­ä½ åŸæœ¬çš„ HTML æ˜¯å¯«æ­»çš„æŒ‰éˆ•ï¼Œè«‹å» HTML æŠŠé‚£å¹¾å€‹æŒ‰éˆ•åˆªæ‰ï¼Œæ›æˆä¸€å€‹ç©ºçš„å®¹å™¨ï¼š
        // <div id="end-controls-area"></div>
        
        const btnArea = document.getElementById('end-controls-area');
        if(btnArea) btnArea.innerHTML = controlsHtml;
    }

    // è‡ªå‹•ç¶å®šæŒ‰éˆ•éŸ³æ•ˆ
    document.querySelectorAll('button, input[type=range]').forEach(el => {
        el.addEventListener('mousedown', () => { if(!el.disabled) sfx.click(); });
    });
// --- ç­†è¨˜è¦–çª—æ§åˆ¶ ---
    function openNote() {
        document.getElementById('note-modal').style.display = 'flex';
    }

    function closeNote() {
        document.getElementById('note-modal').style.display = 'none';
    }

    // é»æ“Šè¦–çª—å¤–éƒ¨ä¹Ÿå¯ä»¥é—œé–‰
    window.onclick = function(event) {
        const modal = document.getElementById('note-modal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
// =========================================================
    // ğŸ¤ èªéŸ³è©•åˆ†ç³»çµ± (è‹±æ–‡ç‰ˆ)
    // =========================================================
    let recognition;
    let isListening = false;
    let currentTargetText = "";

    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = function() {
            isListening = true;
            updateMicUI('è†è½ä¸­...è«‹è®€å‡ºå¥å­', true);
            document.getElementById('mic-feedback').innerHTML = '<span style="color:#888">Listening...</span>';
        };

        recognition.onend = function() {
            isListening = false;
            updateMicUI('è·Ÿè®€é€™å¥ (è©•åˆ†)', false);
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            checkPronunciation(transcript);
        };

        recognition.onerror = function(event) {
            isListening = false;
            updateMicUI('è·Ÿè®€é€™å¥ (è©•åˆ†)', false);
            let msg = "Error";
            if (event.error === 'no-speech') msg = "ğŸ”‡ æ²’è½åˆ°è²éŸ³";
            if (event.error === 'not-allowed') msg = "âŒ éº¥å…‹é¢¨è¢«å°é–";
            document.getElementById('mic-feedback').innerHTML = `<span style="color:var(--danger-color);">${msg}</span>`;
        };
    }

    function toggleMic() {
        if (!recognition) { 
            alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ (å»ºè­°ä½¿ç”¨ Chrome/Safari/Edge)"); 
            return; 
        }
        if (isListening) {
            recognition.stop();
        } else {
            try { recognition.start(); } catch (e) { recognition.stop(); }
        }
    }

    function updateMicUI(text, active) {
        const btn = document.getElementById('mic-btn');
        const status = document.getElementById('mic-status');
        if(status) status.innerText = text;
        if (btn) {
            if (active) btn.classList.add('listening');
            else btn.classList.remove('listening');
        }
    }

const inputs = document.querySelectorAll('.option-btn input');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            const parent = this.parentElement;
            if(this.checked) parent.classList.add('selected');
            else parent.classList.remove('selected');
        });
    });

    function checkPronunciation(spokenText) {
        const feedbackEl = document.getElementById('mic-feedback');
        
        // ç§»é™¤æ¨™é»ä¸¦è½‰å°å¯«ï¼Œä»¥ä¾¿æ¯”å°
        const cleanRaw = (str) => str.toLowerCase().replace(/[.,?!"]/g, "").trim();
        
        const spokenWords = cleanRaw(spokenText).split(/\s+/);
        const targetWords = cleanRaw(currentTargetText).split(/\s+/);
        
        let html = "";
        let correctWords = 0;
        
        // è‹±æ–‡å–®å­—æ¯”å°é‚è¼¯
        let sIndex = 0;
        for (let tIndex = 0; tIndex < targetWords.length; tIndex++) {
            const target = targetWords[tIndex];
            
            if (sIndex < spokenWords.length) {
                const spoken = spokenWords[sIndex];
                if (spoken === target) {
                    html += `<span class="diff-word diff-correct">${target}</span>`;
                    correctWords++;
                    sIndex++;
                } else {
                    // ç°¡å–®å®¹éŒ¯ï¼šå¦‚æœä¸‹ä¸€å€‹å­—å°ä¸Šäº†ï¼Œç•¶ä½œé€™å€‹å­—è®€éŒ¯
                    if (sIndex + 1 < spokenWords.length && spokenWords[sIndex+1] === target) {
                        html += `<span class="diff-word diff-wrong">${spoken}</span> `;
                        html += `<span class="diff-word diff-correct">${target}</span>`;
                        sIndex += 2;
                        correctWords++;
                    } else {
                        html += `<span class="diff-word diff-missed">${target}</span>`;
                        if (spoken) sIndex++; 
                    }
                }
            } else {
                html += `<span class="diff-word diff-missed">${target}</span>`;
            }
        }

        const score = Math.round((correctWords / targetWords.length) * 100);
        let msg = score >= 80 ? "Great Job! ğŸ‰" : (score >= 50 ? "Good Try! ğŸ‘" : "Try Again ğŸ’ª");
        
        if (score === 100 && sfx && sfx.correct) sfx.correct();

        feedbackEl.innerHTML = `
            <div style="font-size:14px; color:#555; margin-bottom:5px;">${msg} (${score}%)</div>
            <div>${html}</div>
        `;
    }
// --- åˆå§‹åŒ–ï¼šç¶å®šæŒ‰éˆ•é»æ“Šæ•ˆæœ & éŸ³æ•ˆ ---
    document.addEventListener('DOMContentLoaded', () => {
        const inputs = document.querySelectorAll('.option-btn input');
        const startBtn = document.getElementById('start-btn');
        
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                // ğŸ”Š 1. æ’­æ”¾ Toggle éŸ³æ•ˆ
                if(sfx && sfx.toggle) sfx.toggle(); 

                // 2. è™•ç†è¦–è¦ºæ•ˆæœ (åŠ æ¸› selected class)
                const parent = this.parentElement;
                if(this.checked) parent.classList.add('selected');
                else parent.classList.remove('selected');
                
                // 3. æª¢æŸ¥æ˜¯å¦è‡³å°‘é¸äº†ä¸€å€‹ (æ§åˆ¶é–‹å§‹æŒ‰éˆ•)
                const checked = document.querySelectorAll('input[name="cat"]:checked');
                if(startBtn) { 
                    startBtn.disabled = (checked.length === 0);
                    startBtn.style.opacity = (checked.length === 0) ? '0.5' : '1';
                }
            });
        });
    });
</script>

</body>

</html>


